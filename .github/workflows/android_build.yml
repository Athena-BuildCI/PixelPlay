# .github/workflows/android_build.yml

name: Android CI Build with Custom Application ID

on:
  workflow_dispatch:
    inputs:
      application_id:
        description: '自定义应用ID (例如 com.example.app.beta)'
        required: true
        default: 'com.theveloper.pixelplay.ci'


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ... [步骤 1-3: Checkout, Set up JDK, Setup Gradle Cache - 保持不变] ...
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ++++++++++++++++ 新增步骤：解码 Keystore ++++++++++++++++
      - name: Decode Keystore
        run: |
          echo "Decoding keystore from GitHub Secrets..."
          # 将 Base64 字符串解码回 keystore 文件
          # 将文件直接放在 app 模块目录下，方便 gradle 脚本引用
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/release-keystore.jks
          echo "Keystore decoded successfully."

      # ++++++++++++++++ 修改步骤：注入所有配置 ++++++++++++++++
      - name: Modify build.gradle.kts for Signing, Splitting and Custom ID
        run: |
          GRADLE_FILE="app/build.gradle.kts"
          
          # 1. 修改 Application ID
          APP_ID=${{ github.event.inputs.application_id || 'com.theveloper.pixelplay.default' }}
          echo "Updating Gradle file with: applicationId: $APP_ID"
          sed -i "s|applicationId = \".*\"|applicationId = \"$APP_ID\"|" $GRADLE_FILE

          # 2. 注入 splits 和 signingConfigs 代码块
          # 将这两个配置块一起插入到 buildTypes 之前
          sed -i '/buildTypes {/i \
              signingConfigs {\
                  create("release") {\
                      storeFile = file("release-keystore.jks")\
                      storePassword = System.getenv("SIGNING_STORE_PASSWORD")\
                      keyAlias = System.getenv("SIGNING_KEY_ALIAS")\
                      keyPassword = System.getenv("SIGNING_KEY_PASSWORD")\
                  }\
              }\
              splits {\
                  abi {\
                      isEnable = true\
                      reset()\
                      include("x86_64", "x86", "armeabi-v7a", "arm64-v8a")\
                      isUniversalApk = false\
                  }\
              }\
          ' $GRADLE_FILE
          
          # 3. 在 release 构建类型中应用签名配置
          # 在 isMinifyEnabled = true 这一行之后，插入签名配置的引用
          sed -i '/isMinifyEnabled = true/a \            signingConfig = signingConfigs.getByName("release")' $GRADLE_FILE

          echo "--- Content of modified $GRADLE_FILE ---"
          cat $GRADLE_FILE
          echo "-------------------------------------------"
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ++++++++++++++++ 修改步骤：在构建时传入环境变量 ++++++++++++++++
      - name: Build Signed APK with Gradle
        # 将 GitHub Secrets 作为环境变量传递给 Gradle
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      # ... [步骤 7: 按ABI分别上传APK构件 - 保持不变] ...
      - name: Upload arm64-v8a APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-arm64-v8a
          path: '**/build/outputs/apk/**/*arm64-v8a*.apk'
          if-no-files-found: warn

      - name: Upload armeabi-v7a APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-armeabi-v7a
          path: '**/build/outputs/apk/**/*armeabi-v7a*.apk'
          if-no-files-found: warn

      - name: Upload x86_64 APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-x86_64
          path: '**/build/outputs/apk/**/*x86_64*.apk'
          if-no-files-found: warn

      - name: Upload x86 APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-x86
          path: '**/build/outputs/apk/**/*x86*.apk'
          if-no-files-found: warn
